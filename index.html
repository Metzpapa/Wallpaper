<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sam's HUD</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            background-color: #111111;
            color: #E5E5E5;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
        }
        
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        #task-input {
            background: transparent;
            border: none;
            outline: none;
            color: #E5E5E5;
            width: 100%;
            font-size: 3rem; /* Made slightly bigger for the focus screen */
            line-height: 1.2;
            resize: none;
        }
        #task-input::placeholder { color: #333; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center">

    <!-- Main Container -->
    <div id="main-container" class="w-full h-full flex p-12 gap-12 transition-all duration-500">
        
        <!-- SECTION A: FOCUS (Active Task) -->
        <!-- Logic: If mode=log, this gets hidden via JS -->
        <div id="focus-view" class="flex-1 flex flex-col justify-center relative transition-all duration-500">
            
            <div class="absolute top-12 left-0 text-gray-600 text-sm tracking-widest uppercase">
                Current Objective
            </div>

            <div class="flex items-start gap-6">
                <!-- Blinking Dot -->
                <div id="status-dot" class="w-5 h-5 rounded-full bg-green-500 shadow-[0_0_15px_#22c55e] blink mt-5 hidden"></div>
                
                <!-- Input -->
                <textarea 
                    id="task-input" 
                    rows="3" 
                    placeholder="Initialize mission..." 
                    autofocus
                    spellcheck="false"
                ></textarea>
            </div>

            <div class="mt-12 text-gray-700 text-xs">
                [ENTER] Save &nbsp;&nbsp; [CMD+ENTER] Complete
            </div>
        </div>

        <!-- SECTION B: LOG (History) -->
        <!-- Logic: If mode=focus, this gets hidden via JS -->
        <div id="log-view" class="flex flex-col justify-end pb-12 transition-all duration-500 w-1/3 border-l border-gray-800 pl-12">
            <div class="text-gray-600 text-sm tracking-widest uppercase mb-6">
                Mission Log
            </div>
            
            <div id="history-list" class="flex flex-col gap-5 overflow-y-auto max-h-[85vh] no-scrollbar">
                <!-- Items injected here -->
            </div>
        </div>

    </div>

    <!-- LOGIC -->
    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://oyennkllpeqmkluwyksz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95ZW5ua2xscGVxbWtsdXd5a3N6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNzA3MTMsImV4cCI6MjA3OTk0NjcxM30.6Az5zgqBc6QbRd8juRWEpjvPtzIztLAzbs_siWIUTTY';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const taskInput = document.getElementById('task-input');
        const statusDot = document.getElementById('status-dot');
        const historyList = document.getElementById('history-list');
        const focusView = document.getElementById('focus-view');
        const logView = document.getElementById('log-view');
        const container = document.getElementById('main-container');

        let currentTaskId = null;

        // --- MODE SELECTION LOGIC ---
        function applyMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode'); // 'focus' or 'log'

            if (mode === 'focus') {
                // HIDE LOG, CENTER FOCUS
                logView.style.display = 'none';
                focusView.classList.remove('flex-1'); // Remove flex-1 to verify full width
                focusView.classList.add('w-full', 'max-w-6xl', 'mx-auto'); // Center it nicely
                container.classList.remove('p-12'); // Adjust padding if needed
                container.classList.add('px-24');
            } 
            else if (mode === 'log') {
                // HIDE FOCUS, EXPAND LOG
                focusView.style.display = 'none';
                logView.classList.remove('w-1/3', 'border-l', 'pl-12'); // Remove side constraints
                logView.classList.add('w-full', 'px-8'); // Full width for vertical monitor
                
                // Adjust typography for vertical view
                historyList.classList.remove('max-h-[85vh]');
                historyList.classList.add('max-h-screen');
            }
        }

        // --- DATA LOGIC ---
        async function loadData() {
            const { data: activeTasks } = await supabase
                .from('tasks')
                .select('*')
                .eq('status', 'active')
                .limit(1);

            if (activeTasks && activeTasks.length > 0) {
                const task = activeTasks[0];
                taskInput.value = task.content;
                currentTaskId = task.id;
                statusDot.classList.remove('hidden');
            } else {
                taskInput.value = "";
                currentTaskId = null;
                statusDot.classList.add('hidden');
            }
            fetchHistory();
        }

        async function fetchHistory() {
            const { data: history } = await supabase
                .from('tasks')
                .select('*')
                .eq('status', 'done')
                .order('completed_at', { ascending: false })
                .limit(20);

            renderHistory(history || []);
        }

        function renderHistory(tasks) {
            historyList.innerHTML = '';
            tasks.forEach(task => {
                const date = new Date(task.completed_at);
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const html = `
                <div class="flex gap-4 text-gray-500 hover:text-gray-400 transition-colors cursor-default">
                    <span class="text-xs pt-1 opacity-40 font-mono whitespace-nowrap">[${timeStr}]</span>
                    <span class="text-xl opacity-70">${task.content}</span>
                </div>
                `;
                historyList.innerHTML += html;
            });
        }

        async function saveActiveTask() {
            const content = taskInput.value.trim();
            if (!content) return;
            statusDot.classList.remove('hidden');
            if (currentTaskId) {
                await supabase.from('tasks').update({ content }).eq('id', currentTaskId);
            } else {
                const { data } = await supabase.from('tasks').insert([{ content, status: 'active' }]).select();
                if (data) currentTaskId = data[0].id;
            }
        }

        async function completeTask() {
            if (!currentTaskId) return;
            const now = new Date().toISOString();
            await supabase.from('tasks').update({ status: 'done', completed_at: now }).eq('id', currentTaskId);
            taskInput.value = "";
            currentTaskId = null;
            statusDot.classList.add('hidden');
            fetchHistory();
        }

        // --- INIT ---
        applyMode(); // Set layout based on URL
        loadData(); // Load data from Supabase
        
        // Listeners
        taskInput.addEventListener('blur', saveActiveTask);
        taskInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                if (e.metaKey || e.ctrlKey) {
                    e.preventDefault();
                    await saveActiveTask();
                    await completeTask();
                } else {
                    e.preventDefault(); 
                    await saveActiveTask();
                }
            }
        });

        // Auto-refresh for syncing between monitors
        setInterval(loadData, 5000); 

    </script>
</body>
</html>
